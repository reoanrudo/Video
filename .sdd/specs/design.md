# 実装設計（MVPリリース 2025-12-20）\n\n## アーキテクチャ概要\n- サーバー: Laravel 12 / PHP 8.2。認証は Fortify。`ProjectController`/`ProjectAnalysisController` を継続利用。\n- フロント: Vite 7 + Tailwind 4。Editor は Blade (`resources/views/editor.blade.php`) + vanilla JS (`resources/js/editor/*`)。Livewire/Volt は設定系のみ。\n- データ: `projects.analysis_json` に `videocoach.analysis@1.0.0` を保存。JSON Schema 検証は `SaveAnalysisRequest` で継続。\n\n## ユースケース別フロー\n1. Dashboard: `/dashboard` でプロジェクト一覧・新規作成 → `projects.store`\n2. Editor: `/editor/{project}` で動画アップ・注釈。初期 state は `analysis_json`。\n3. 保存: PUT `/api/projects/{project}/analysis` → `ProjectAnalysisController@update` → DB 保存。\n4. 復元: GET `/api/projects/{project}/analysis` → state hydrate → redraw。\n\n## モデル / スキーマ\n- `Project` モデル: 既存フィールド継続 (`analysis_schema_version`, `analysis_json`)。\n- `analysis_json` 構造: `.codex/docs/drawing-engine.md`・`editor-interactions.md` に準拠。動画ピクセル座標のみ。`extensions.kvaPassthrough` を温存。\n\n## フロント実装方針\n- Renderer/Store: `renderer.js`, `store.js` を基盤に再構築。mapper は `canvas-mapper.js` を唯一の変換ソースに統一。\n- ツール切替/ハンドル: state machine を整理し、ツール追加時は `store.currentTool` と `hitTest` の switch を拡張。\n- キーイメージ自動生成: 注釈確定時に ±0.3s 判定で自動追加。重複は `timeSec` 近傍比較。\n- Undo/Redo: 履歴キューはドラッグ終了や確定イベントで push。連続ドラッグはデバウンス。\n- UI: ステータス表示とトーストで保存結果を通知。\n\n## バックエンド方針\n- バリデーション: `SaveAnalysisRequest` で schema 固定、drawings/geometry/variant/style を許容。必要に応じ shape を段階追加。\n- 認可: `abort_unless(Auth::user()->is($project->user), 403)` を踏襲。共有機能実装までは owner のみ。\n\n## デプロイ/インフラ（初期案）\n- コンテナ: PHP-FPM + Nginx（Octane なし）。\n- ストレージ: S3 互換バケットを想定。環境変数でバケット/リージョン/ACL を指定し、後続でアップロード実装。\n- DB: 本番は Postgres/MySQL 推奨（現状 SQLite）。\n- CI/CD: GitHub Actions で `composer install --no-dev`, `npm ci && npm run build`, `php artisan test` 実行 → コンテナ build/push → デプロイ。\n\n## 受け入れテスト観点\n- ツール: 13 ツールで「追加→選択/移動→削除→Undo/Redo→保存→再読込」再現。\n- キーイメージ: 手動/自動/重複抑止/ジャンプ。\n- 認可: 他ユーザーで GET/PUT は 403。\n- バリデーション: スキーマ不一致は 422、DB 不変更。\n- 回帰: docs/BUG_DRAWING.md のシナリオで初期描画が即時に見える。\n\n## 残課題 / 決定待ち\n- KPI 数値、動画保存先・容量上限、共有/エクスポート要件、モバイル対応要否、本番 DB/バケット/デプロイ先。\n- 大容量（>500MB）対応が必要なら chunked upload/署名付きURL を検討。\n\n## 追加: 描画ツール再設計メモ\n- `Kinovea-Japanese.pdf` に基づくツール一覧とデータモデルを `.sdd/specs/drawing-redesign.md` に整理。\n- 実装ステップ: (1)基盤復旧 → (2)最小ツールセット復活 → (3)バリアント拡張 → (4)ヒットテスト/ハンドル拡充 → (5)保存/復元整備 → (6)QA。\n*** End Patch
