# 描画ツール再設計（Kinovea準拠ベース）\n\n出典: `Kinovea-Japanese.pdf` 4章「描画ツールの利用」(p13-18 相当)\n\n## ツール一覧と挙動\n番号は Kinovea UI に対応。\n\n1. 移動ツール: 既存描画の選択・移動・ハンドル操作。\n2. キーイメージ: 現在時刻をキーイメージとして追加。注釈確定時の自動追加も維持。\n3. コメント: 動画上に表示しないメモ（メタ）。\n4. テキスト / オートナンバー: クリックで配置。オートナンバーは連番を自動付与。\n5. ペン: フリーハンドパス。\n6. Human model系: 人体/Bike/Archery/水平距離/Genu/Posture 等の複合モデル（MVP外、Phase2+）。\n7. ライン/Polyline/円: 直線（長さ表示オプション）、折れ線、円。\n8. 矢印: 通常/破線/波線/曲線/ポリライン/ポリライン破線/ポリライン波線。\n9. クロスマーカー: 点配置＋座標表示。原点は別途設定（origin）。\n10. 角度系: 3点角度、Goniometer、水平基準角、垂直基準角。\n11. ストップウォッチ: 区間時間計測。\n12. パースペクトグリッド系: グリッド・較正（MVP外）。\n13. トラック簡易: 軌跡（追尾なし）。\n14. 図形: 矩形/楕円など（円は7に含む）。\n15. テンプレ/スタンプ: 汎用スタンプ。\n\n## MVP/Phase方針（再設計）\n- **MVP再有効化**: 1,2,3,4(テキストのみ),5,7(ライン/円),8(通常/破線/波線/曲線/ポリライン各1),9,10(3点角度/水平/垂直),11,13,14(円相当のみ),15(最小スタンプ)。\n- **後回し (Phase2+)**: 6のHuman model系、12パースペクトグリッド高度化、オートナンバー、Polyline長さ表示の実寸換算、トラック追尾、スタンプ拡張。\n\n## データモデル（analysis.drawings[]）\n共通: `id`, `type`, `variant`, `style{color,lineWidth,opacity,dashLength,dashGap,squiggleAmplitude,squiggleWavelength,curvature}`\n- line: `{start{x,y}, end{x,y}}`\n- arrow: `variant` 上記 7 種。`geometry` は variant に応じて `start/end`, `control`, `points[]`。\n- pen: `path[]`\n- circle: `{center{x,y}, radius}`\n- marker/cross: `{position{x,y}}`\n- text: `{position{x,y}, content, fontSize}`\n- angle: `variant=three_point|to_horizontal|to_vertical`, `points[3]`\n- stopwatch: `{start{x,y}, end{x,y}, timeSec}`（計測結果を保持）\n- track: `{path[]}`\n- stamp: `{position{x,y}, name}`\n- comment: `{content, timeSec}`（動画上には描画しない）\n- keyframes: 既存通り `id, time, label`\n\n## 画面・UX再構成\n- ツールバー: ボタン + variant セレクタ（ドロップダウン）。長押し代替はセレクトで行う。\n- サイドパネル: 描画リスト（選択/削除）、スタイル編集（色/線幅/opacity/dash/squiggle/curve）、ツール特有プロパティ（テキスト内容など）。\n- キーイメージ: 手動＋自動（注釈確定時、±0.3s重複抑止）を維持。\n- ステータス/トースト: 保存成功/失敗を表示。\n\n## 実装ステップ案\n1) **基盤復旧**: store/renderer/hittest を再導入（現行最小版から差し戻し）。mapper・distance等は既存ファイルを再利用。\n2) **最小ツールセット復活**: select, marker, line, arrow(normal), circle, text, pen, angle(three_point), keyframe, delete/undo/redo。\n3) **バリアント追加**: arrow dash/squiggly/curve/polyline*, angle to_horizontal/to_vertical。\n4) **ヒットテスト/ハンドル**: variant別ハンドル（curve control, polyline points）。\n5) **UI連携**: サイドパネルのスタイルとツールプロパティを再接続。描画リストとタイムラインを連動。\n6) **保存/読み込み**: analysis_json に全ツール geometry を保存。未知フィールドは温存。\n7) **QA**: 既存ユニット＋手動シナリオ（追加→移動→削除→保存→再読込）。\n\n## バリデーション方針（SaveAnalysisRequest）\n- 共通: `drawings.*.type` 必須、`geometry` 必須（中身は寛容に許可）。\n- `style` は配列許可、`variant` 文字列許可。\n- `origin` 任意。`meta` 任意。\n- 厳格な geometry shape は将来必要になったツールから段階的に追加。\n\n## 備考\n- パースペクトグリッド/実寸換算は Phase2 で取り込み。MVPでは canvas px ベースの相対計測のみ。\n- 人体モデル系は UI/データが大きくなるため除外。必要時は別 schema version を検討。\n*** End Patch
